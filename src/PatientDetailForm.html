<div class="details-grid">
    <div class="header-info">
        <h3>Patient: <?!= patient.patientName ?></h3>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <a role="button"
               href="mailto:<?!= patient.patientEmail ?>"
               class="secondary small"
               title="Send email to <?!= patient.patientEmail ?>">
                Email: <?!= patient.patientEmail ?>
            </a>

            <a role="button"
               href="tel:<?!= patient.patientPhone ?>"
               class="secondary small"
               title="Call <?!= patient.patientPhone ?>">
                Call: <?!= patient.patientPhone ?>
            </a>
        </div>

        <div><a role="button" href="<?!= patient.patientSS.getUrl(); ?>">Open Patient Sheet</a>
        <a role="button" href="<?!= patient.patientFolder.getUrl(); ?>">Open Patient Folder</a></div>
        
    </div>

    <div class="data-card">
        <h3>Summary</h3>
        <p><strong>Last Visit:</strong> <?!= patient.lastVisit ? patient.lastVisit.getFormattedAppointmentDate() : 'N/A' ?></p>
        <p><strong>Last Diagnosis:</strong> <?!= patient.lastVisit ? patient.lastVisit.diagnosis || 'N/A' : 'N/A' ?></p>

        <hr style="border: 0; border-top: 1px solid #ddd; margin: 15px 0;">

    </div>

    <div id="new-visit-container">
        <?!= embedController(newVisitController, patient) ?>
    </div>

    <div id="calendar-container">
        <?!= embedController(calendarController, {}) ?>
    </div>
</div>

<script>
    const form =  document.getElementById('new-visit-form');
    initForm(form);

    function initForm(form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Stop the default form submission

            const patientId = document.getElementById('patient-id').value;
            const visitDate = document.getElementById('visit-date').value;
            const visitTime = document.getElementById('visit-time').value;
            const visitPrice = document.getElementById('visit-price').value.trim();
            const notes = document.getElementById('initial-notes').value.trim();

            const statusDiv = document.getElementById('visit-status');
            const scheduleButton = document.getElementById('schedule-button');

            if (!patientId || !visitDate || !visitTime || !notes) {
                statusDiv.textContent = 'All fields are required.';
                return;
            }

            // Disable button and show status
            scheduleButton.disabled = true;
            scheduleButton.textContent = 'Processing...';
            statusDiv.textContent = 'Creating calendar event and updating log...';
            statusDiv.style.color = '#FFA500'; // Orange for pending

            // Asynchronously call the server-side function
            // TODO: revisit action on success. (reload/Home/)
            google.script.run
                .withSuccessHandler(function(response) {
                    handleServerResponse(response);
                    if (response.status >= 400) {
                        const container = document.getElementById("new-visit-container");
                        if (container) {
                            // 1. Replace the entire container content with the new HTML (including the form)
                            container.innerHTML = response.content;

                            // 2. CRITICAL STEP: The old form listener is gone,
                            //    so we must attach the listener to the new form element.
                            const newForm = document.getElementById('new-visit-form"');
                            if (newForm) {
                                initForm(newForm);
                            }
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    statusDiv.textContent = 'Failed to book visit: ' + error.message;
                    statusDiv.style.color = 'red';
                    scheduleButton.disabled = false;
                    scheduleButton.textContent = 'Schedule & Create Log Entry';
                })
                //patientLogSSId, visitDate, visitTime, visitPrice, notes
                .asyncEmbedController('bookNewVisit', {patientId, visitDate, visitTime, visitPrice, notes}); // <-- Calls your server function
        });
    }
</script>